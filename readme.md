# 本文描述了google play 和 appstore的订阅支付相关问题
### 一、事件
##### 【开通】事件
1. Apple 
- 首次订阅，客户端会调用verify接口，后台判断是否为首次购买（original_transaction_id == transaction_id），如果是，则插入一条事件到DB，表示开通事件。
- 过期后，再次购买（有可能在appstore续费的，不一定走verify接口），后台在收到notice(用户状态变化)后，查询用户的当前状态，如果为过期？而此次的receipt对应的过期时间是在未来？则表示用户重新开通了。此时，插入一条事件到DB，表示开通。

2. Google
- 首次开通，根据事件走。

##### 【续费】事件
1. Apple
- 异步扫描的进程，每5秒扫描一次DB，将最近要处理的事件，拿出来查询其状态，并处理掉。 在用户购买以后，立即可扫描出【开通】的事件，回调订阅服务，并发出开通事件。在调用成功以后，删除该【开通事件】，插新插入一条【续费】事件，并设置下次检查时间为 expires_time - 24 小时。

2. Google
- 根据事件判断【续费】事件

##### 【过期】事件
1. Apple
- 异步扫描的进程，在扫描到【续费】事件时，每小时扫描一次，当扫描到expires_time 过期了，则判断为【过期】事件。

2. Google 
- 根据事件判断【过期】事件

##### 【取消】事件
1. Apple 
- 当收到用户状态变化的Apple Notice事件时，判断用户之前的状态为 【续订】，而本次receipt对应的状态为【未续订】，则可判断本次为取消续订事件。
2. Google
- 根据事件判断【取消订阅】

##### 【退款】事件
1. Apple
- 根据事件来判断
2. Google 
- 根据事件来判断 

##### 【继续续订】事件
1. Apple
- 当收到用户状态变化的Apple Notice事件时，判断用户之前的状态为【取消】，而本次receipt对应的状态为【续订】，则可判断本次为继续续订事件。
2. Google
- 根据事件来判断


